name: Deploy Portfolio Showcase to GitHub Pages

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

env:
  NODE_VERSION: '18'
  BUILD_PATH: './'

jobs:
  # Build job
  build:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: ğŸ“¦ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: package.json
      
      - name: ğŸ’¾ Install Dependencies
        run: |
          # Install only production dependencies since this is a static site
          npm install --omit=dev
          echo "Dependencies installed successfully"
      
      - name: âš™ï¸ Create Build Directories
        run: |
          mkdir -p dist/styles
          mkdir -p dist/scripts
          mkdir -p dist/assets/images
          mkdir -p reports
          echo "Build directories created"
      
      - name: ğŸ” Basic Validation
        run: |
          echo "Validating project structure..."
          # Check if required files exist
          test -f index.html || (echo "index.html missing" && exit 1)
          test -f styles/main.css || (echo "main.css missing" && exit 1)
          test -f scripts/main.js || (echo "main.js missing" && exit 1)
          echo "All required files present"
      
      - name: ğŸ¨ Prepare CSS
        run: |
          echo "Preparing CSS files..."
          cp styles/main.css dist/styles/main.css
          echo "CSS files prepared"
      
      - name: âš¡ Prepare JavaScript
        run: |
          echo "Preparing JavaScript files..."
          cp scripts/main.js dist/scripts/main.js
          echo "JavaScript files prepared"
      
      - name: ğŸ“Š Generate Build Info
        run: |
          echo "{
            \"build_date\": \"$(date -u +\"%Y-%m-%dT%H:%M:%SZ\")\",
            \"commit_sha\": \"${{ github.sha }}\",
            \"commit_ref\": \"${{ github.ref }}\",
            \"workflow_run\": \"${{ github.run_number }}\",
            \"actor\": \"${{ github.actor }}\",
            \"repository\": \"${{ github.repository }}\"
          }" > build-info.json
          echo "Build info generated"
      
      - name: ğŸ“¤ Setup Pages
        uses: actions/configure-pages@v4
      
      - name: ğŸ“œ Upload Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ${{ env.BUILD_PATH }}
  
  # Deploy job
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        
      - name: âœ… Deployment Success
        run: |
          echo "ğŸ‰ Portfolio showcase deployed successfully!"
          echo "ğŸ”— Site URL: ${{ steps.deployment.outputs.page_url }}"
          echo "ğŸ“… Deployment time: $(date -u)"
          echo "ğŸ“Š Commit: ${{ github.sha }}"
  
  # Basic check job (runs on PRs)
  check:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: ğŸ“¦ Checkout
        uses: actions/checkout@v4
      
      - name: ğŸ” Basic File Validation
        run: |
          echo "Checking required files..."
          test -f index.html && echo "âœ“ index.html found"
          test -f styles/main.css && echo "âœ“ styles/main.css found"
          test -f scripts/main.js && echo "âœ“ scripts/main.js found"
          test -f package.json && echo "âœ“ package.json found"
          test -f README.md && echo "âœ“ README.md found"
          echo "All files validated successfully!"
      
      - name: ğŸ“ Check HTML Structure
        run: |
          echo "Checking HTML structure..."
          # Basic HTML structure validation
          grep -q '<html lang="ro">' index.html && echo "âœ“ HTML lang attribute correct"
          grep -q '<meta charset="UTF-8">' index.html && echo "âœ“ Charset meta tag present"
          grep -q '<meta name="viewport"' index.html && echo "âœ“ Viewport meta tag present"
          grep -q 'George Pricop' index.html && echo "âœ“ Author information present"
          echo "HTML structure validation completed!"