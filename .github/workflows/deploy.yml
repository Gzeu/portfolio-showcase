name: Deploy Portfolio Showcase to GitHub Pages

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

env:
  NODE_VERSION: '18'
  BUILD_PATH: './'

jobs:
  # Build job
  build:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: 📦 Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: 🔧 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: package.json
      
      - name: 💾 Install Dependencies
        run: |
          # Install only production dependencies since this is a static site
          npm install --omit=dev
          echo "Dependencies installed successfully"
      
      - name: ⚙️ Create Build Directories
        run: |
          mkdir -p dist/styles
          mkdir -p dist/scripts
          mkdir -p dist/assets/images
          mkdir -p reports
          echo "Build directories created"
      
      - name: 🔍 Basic Validation
        run: |
          echo "Validating project structure..."
          # Check if required files exist
          test -f index.html || (echo "index.html missing" && exit 1)
          test -f styles/main.css || (echo "main.css missing" && exit 1)
          test -f scripts/main.js || (echo "main.js missing" && exit 1)
          echo "All required files present"
      
      - name: 🎨 Prepare CSS
        run: |
          echo "Preparing CSS files..."
          cp styles/main.css dist/styles/main.css
          echo "CSS files prepared"
      
      - name: ⚡ Prepare JavaScript
        run: |
          echo "Preparing JavaScript files..."
          cp scripts/main.js dist/scripts/main.js
          echo "JavaScript files prepared"
      
      - name: 📊 Generate Build Info
        run: |
          echo "{
            \"build_date\": \"$(date -u +\"%Y-%m-%dT%H:%M:%SZ\")\",
            \"commit_sha\": \"${{ github.sha }}\",
            \"commit_ref\": \"${{ github.ref }}\",
            \"workflow_run\": \"${{ github.run_number }}\",
            \"actor\": \"${{ github.actor }}\",
            \"repository\": \"${{ github.repository }}\"
          }" > build-info.json
          echo "Build info generated"
      
      - name: 📤 Setup Pages
        uses: actions/configure-pages@v4
      
      - name: 📜 Upload Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ${{ env.BUILD_PATH }}
  
  # Deploy job
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: 🚀 Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        
      - name: ✅ Deployment Success
        run: |
          echo "🎉 Portfolio showcase deployed successfully!"
          echo "🔗 Site URL: ${{ steps.deployment.outputs.page_url }}"
          echo "📅 Deployment time: $(date -u)"
          echo "📊 Commit: ${{ github.sha }}"
  
  # Basic check job (runs on PRs)
  check:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: 📦 Checkout
        uses: actions/checkout@v4
      
      - name: 🔍 Basic File Validation
        run: |
          echo "Checking required files..."
          test -f index.html && echo "✓ index.html found"
          test -f styles/main.css && echo "✓ styles/main.css found"
          test -f scripts/main.js && echo "✓ scripts/main.js found"
          test -f package.json && echo "✓ package.json found"
          test -f README.md && echo "✓ README.md found"
          echo "All files validated successfully!"
      
      - name: 📝 Check HTML Structure
        run: |
          echo "Checking HTML structure..."
          # Basic HTML structure validation
          grep -q '<html lang="ro">' index.html && echo "✓ HTML lang attribute correct"
          grep -q '<meta charset="UTF-8">' index.html && echo "✓ Charset meta tag present"
          grep -q '<meta name="viewport"' index.html && echo "✓ Viewport meta tag present"
          grep -q 'George Pricop' index.html && echo "✓ Author information present"
          echo "HTML structure validation completed!"